<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><{$title|default='V聊天平台'}></title>

	  <link rel="stylesheet" type="text/css" href="__RESOURCE__Dist/css/bootstrap.min.css" />
	  <link rel="stylesheet" type="text/css" href="__RESOURCE__Home/css/general.css" />
	  <link rel="stylesheet" type="text/css" href="__RESOURCE__Chat/main.css" />

      <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>



	  <script src='__RESOURCE__Chat/socket.io.js'></script>

	  <script src='//cdn.bootcss.com/jquery/1.11.3/jquery.js'></script>
	  <script src='__RESOURCE__Chat/notify.js'></script>
	  <script src='__RESOURCE__Dist/js/jquery.min.js'></script>
	  <script src='__RESOURCE__Dist/js/bootstrap.min.js'></script>
	  <style>
		  .child-list{
			  font-size: 12px;
		  }
		  .icon{
			  width: 28px;
			  margin: 0px 10px;
		  }
		  .container{
			  background: #fff;
		  }
	  </style>
    <block name="include"></block>
  </head>
  <body style="background: #f4f5f7;">

    <div class="container">
	    <div class="row">
		    <div class="col-sm-12">
		    	<block name="header">
					<div class="row header">
						<div class="col-sm-4"><a href="<{:url('Index/index')}>">首页</a><img style="height: 28px;max-width: 300px;" src="__ROOT__/Uploads/<{:session('home.logo')}>" alt=""></div>
						<div class="col-sm-4"></div>
						<div class="col-sm-4">
							<div class="fr">
								<if condition="session('home.userInfo') == ''">
									<a href="<{:url('User/Login')}>">登录</a>|<a href="<{:url('User/Register')}>">注册</a>
								<else />
									<a href="<{:url('index/index')}>"><img class="icon" src="<{UPLOAD_URL . :session('home.userInfo.icon')}>" alt="..." class="img-circle"><{$_SESSION['home']['userInfo']['username']}>（<{$_SESSION['home']['userInfo']['identity']}>） </a>&nbsp;|&nbsp;<a
									href="<{:url('User/loginout')}>">退出</a>&nbsp;|&nbsp;<a href="<{:url('Center/Index')}>">个人中心</a>
								</if>
							</div>
						</div>
					</div>
				</block>
				<block name="search">
					<div class="row search mt20">
						<div class="col-sm-3"><img style="height:80px;max-width: 500px; " src="<{UPLOAD_URL . :session('home.logo')}>" alt=""></div>
						<div class="col-sm-9">
							<form class="form-inline fr mt20" role="form" action="" method="get">
								<input type="text" class="form-control" id="" placeholder="搜索">
								<button type="submit" class="btn btn-default">search</button>
							</form>
						</div>
					</div>
				</block>
				<block name="nav">
					<div class="row mt20">
						<div class="col-sm-12">
							<ul class="nav">
								<li class="fl"><a href="#" class="index-a">首页</a></li>
							</ul>
						</div>					
					</div>
				</block>
				<block name="body">
					<div class="row body mt20">
						<div class="col-sm-8 mt20">
							<div id="carousel-example-generic" class="carousel slide" data-ride="carousel" style="width: 600px; height:450px; margin: 20px auto">
								  <!-- Indicators -->
								<ol class="carousel-indicators">
								    <li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
								    <li data-target="#carousel-example-generic" data-slide-to="1"></li>
								    <li data-target="#carousel-example-generic" data-slide-to="2"></li>
								</ol>

								  <!-- Wrapper for slides -->
								<div class="carousel-inner" role="listbox" >
								    <div class="item active">
								      	<img src="../Images/1.jpg" alt="...">
								      	<div class="carousel-caption">
								        第一张
								      	</div>
								    </div>
								    <div class="item">
								      	<img src="../Images/2.jpg" alt="...">
								      	<div class="carousel-caption">
								        第二张
								      	</div>
								    </div>
								    <div class="item">
								      	<img src="../Images/3.jpg" alt="...">
								      	<div class="carousel-caption">
								        第三张
								      	</div>
								    </div>
								</div>

								  <!-- Controls -->
								<a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
								    <span class="glyphicon glyphicon-chevron-left"></span>
								    <span class="sr-only">Previous</span>
								</a>
								<a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
								    <span class="glyphicon glyphicon-chevron-right"></span>
								    <span class="sr-only">Next</span>
								</a>
							</div>
						</div>
						<div class="col-sm-4 mt20">
							<ul class="list-ul mt20">
								<li class="title-li">今日热点</li>
								<li class="list-li"><a href="#">第一</a></li>
								<li class="list-li"><a href="#">第二</a></li>
								<li class="list-li"><a href="#">第三张</a></li>
								<li class="list-li"><a href="#">第四张</a></li>
							</ul>
						</div>
					</div>
				</block>
				<block name="footer">
					<div class="row footer mt20">
						<div class="col-sm-4">
							<h4>友情链接</h4>
							<ul>
								<volist name="links" id="vo">
									<li><a href="<{$vo.link}>"><{$vo.name}></a></li>
								</volist>
							</ul>
						</div>
						<div class="col-sm-4">
							<h4>开发人员</h4>
							<ul>
								<li><a href="#">黄蓉蓉</a></li>
							</ul>
						</div>
						<div class="col-sm-4">
							<h4>运用技术</h4>
							<ul>
								<li><a href="#">Thinkphp</a></li>
								<li><a href="#">websocket</a></li>
							</ul>
						</div>
					</div>
				</block>
				<block name="chat">
					<div class="row" >
						<div class="col-sm-3 col-sm-offset-9" style="position: fixed;right:20px;bottom: 20px;">
							<div class="chat btn btn-default" style="width: 300px;background: #e0e0e0;"> <div class="chat-bar glyphicon glyphicon-chevron-up"></div> </div>
							<div class="friendlist" style="display: none;height: 320px;overflow: auto;">
								<ul class="list-group" style="margin-top: 0px;">
								  <li class="list-group-item">
									  <div class="online">在线好友</div>
									  <ul class="child-list"  id="online-friend" style="display: none;">
									  </ul>
								  </li>
								  <li class="list-group-item">
									  <div class="online">全站在线：<span id="online_box"></span></div>
									  <ul class="child-list" id="online-all" style="display: none;">

									  </ul>
								  </li>
								</ul>
								<script>
									$(function(){
										$('.online').click(function (obj) {
											$('.online').next('ul').slideUp();
											if($(this).next('ul:eq(0)').css('display')=='block'){
												$(this).next('ul:eq(0)').slideUp();
											}else{
												$(this).next('ul:eq(0)').slideDown();
											}

										});
									});
								</script>
							</div>
							<script>
								$(function(){
									$('.chat').click(function(){
										$('.friendlist').slideToggle();
										$('.chat-bar').toggleClass("glyphicon-chevron-up");
										$('.chat-bar').toggleClass("glyphicon-chevron-down");
										if($('.friendlist').css('display')=='block'){
											$('.friendlist').animate({ 
											    width: "300px",
											    height: "320px"
											  }, 1000 );
										}
									});

									$(document).on('click',"#addfriend",function(e){
										fid = $(this).attr('fid');
										$.ajax({
											url:"<{:url('Friend/ajaxAddFriend')}>",
											type:'get',
											data:'fid='+fid,
											success: function (data) {
												if(data===0  ){
													alert('呀！出错了！');
												}else if(data===1){
													alert('申请已发送！');
												}else if(data===2){
													alert('请勿重复申请！');
												}else if(data===3){
													alert('自己不需要申请！');
												}else{
													alert('呀！出错了！');
												}
											},
											error:function(data){
											}
										});

									});
								})
							</script>
							<script>
								$(document).ready(function () {
								    var uid = <{:session('home.userInfo.id')}> ;
								    $('.uid').html(uid);
								    // 连接服务端
								    var socket = io('http://'+document.domain+':2120');
								    // 连接后登录
								    socket.on('connect', function(){
								    	socket.emit('login', uid);							        
								    });
								    // 后端推送来消息时
								    socket.on('new_msg', function(from,msg){
								         $('#content').html('收到消息：'+msg);console.log(msg);
								    });



								    // 后端推送来在线数据时
								    socket.on('update_online_count', function(online_stat,userlist){
								        $('#online_box').html(online_stat);
										console.log( userlist);
										$.ajax({
											url: "<{:url('User/ajaxGetUserList')}>",
											type:'get',
											data: 'userlist='+userlist,
											success: function(data){
												userarr=eval('('+data+')');
												if( userarr && userarr.length >0 ){
//													return false;
													for(var i =0 ; i < userarr.length ; i++){
														$('#online-all').append('<li> '+userarr[i]['username'] +'<a class="guanzhu fr" id="addfriend" fid="'+userarr[i]['id']+'">添加好友</a></li>');
													}
												}

											},
											error:function(data){
												alert('获取用户列表出错');
											}
										});

										$.ajax({
											url: "<{:url('Friend/ajaxGetFriendList')}>",
											type:'get',
											data: 'userlist='+userlist,
											success: function(data){
												var userarr=eval('('+data+')');
												if(userarr && userarr.length >0 ){
//													return false;
													for(var i =0 ; i < userarr.length ; i++){
														$('#online-friend').append('<li fid="'+userarr[i]['id']+'"><span class="name">'+userarr[i]["username"]+'</span><span class="fr deletefriend">解除好友</span>'+'</li>');
													}
													$('#online-friend').prev('.online').text($('#online-friend').prev('.online').text()+'：'+userarr.length);
												}


											},
											error:function(data){
//												alert('获取用户列表出错');
											}
										});
								    });
									socket.on('new_request', function(from){
										$.ajax({
											url: "<{:url('User/ajaxGetUser')}>",
											type:'get',
											data: 'id='+from,
											success: function(data){
												if(data == 0){
													return false;
												}
												data = eval('('+data+')');
												var res = confirm(data['username']+"与你聊天");
												if(res){
//													window.location.href="<{:url('Chat/Index')}>?fid="+data['id'];
													window.open("<{:url('Chat/Index')}>?fid="+data['id']);
												}
												console.log(data);
											},
											error:function(data){
												alert('获取用户列表出错');
											}
										});
									});
								    $('#submit').click(function(){
								        to = $('#to').val();
								        msg = $('#msg').val();
								        msg = 'from:'+<{:session('home.userInfo.id')}>+',to:'+$('#to').val()+',content:'+$('#msg').val()+'';console.log(msg);
								        res = socket.emit('send_msg',msg);
								    });
									$(document).on('click',"#online-friend li .name",function(e){
										// 发起聊天请求
										var to = $(this).parent().attr('fid');
										var res = socket.emit('request', <{:session('home.userInfo.id')}>  ,to);
//										window.location.href="<{:url(\'Chat/Index\')}>?fid="+to;
										window.open("<{:url(\'Chat/Index\')}>?fid="+to);
									});

									$(document).on('click',"#online-friend li .deletefriend",function(e){
										// 发起聊天请求
										var fid = $(this).parent().attr('fid');
										handle = $(this).parent();
										$.ajax({
											url: "<{:url('Friend/ajaxDeleteFriend')}>",
											type:'get',
											data: 'fid='+fid,
											success: function(data){
												if(data==1){
													alert('已解除好友！');
													location.reload();
												}else{
													alert('操作失败！');
													location.reload();
												}
											}
										});
									});
								});
							</script>
							<block name="script">

							</block>
						</div>
					</div>
				</block>
		    </div>
	    </div>	
    </div>  
  </body>
</html>